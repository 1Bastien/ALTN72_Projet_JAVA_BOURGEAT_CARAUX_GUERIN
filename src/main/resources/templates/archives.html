<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>Archives - Gestion des étudiants</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      th:href="@{/webjars/bootstrap/css/bootstrap.min.css}"
      rel="stylesheet"
    />
    <link th:href="@{/css/main.css}" rel="stylesheet" />
    <link th:href="@{/fonts/fontawesome/css/all.min.css}" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}" />
  </head>
  <body>
    <div th:replace="~{fragments/header :: main-header}"></div>

    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-primary mb-0">Archives</h1>
        <a th:href="@{/}" class="btn btn-outline-primary">
          <i class="fas fa-arrow-left me-2"></i>Retour au tableau de bord
        </a>
      </div>

      <div
        th:if="${errorMessage}"
        class="alert alert-danger alert-dismissible fade show"
        role="alert"
      >
        <i class="fas fa-exclamation-circle me-2"></i>
        <span th:text="${errorMessage}"></span>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      <div
        th:if="${successMessage}"
        class="alert alert-success alert-dismissible fade show"
        role="alert"
      >
        <i class="fas fa-check-circle me-2"></i>
        <span th:text="${successMessage}"></span>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>

      <div class="card shadow-sm border-0">
        <div
          class="card-header bg-primary text-white py-3 d-flex justify-content-between align-items-center"
        >
          <h4 class="card-title mb-0 fs-5 text-center w-100">
            Étudiants archivés
          </h4>
        </div>

        <div class="card-body">
          <div th:if="${archivedStudents.empty}" class="text-center py-5">
            <i class="fa-solid fa-archive fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Aucun étudiant archivé.</h5>
            <p class="text-muted">Les étudiants archivés apparaîtront ici.</p>
          </div>

          <div th:if="${!archivedStudents.empty}" class="table-responsive p-0">
            <table
              class="table table-bordered table-hover mb-0 text-center align-middle"
            >
              <thead class="bg-light fw-bold">
                <tr>
                  <th class="py-3">Nom</th>
                  <th class="py-3">Prénom</th>
                  <th class="py-3">Email</th>
                  <th class="py-3">Téléphone</th>
                  <th class="py-3">Dernier programme</th>
                  <th class="py-3">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  th:each="student : ${archivedStudents}"
                  class="clickable-row"
                  th:data-href="@{/student/{id}(id=${student.id})}"
                  style="cursor: pointer"
                >
                  <td class="py-3" th:text="${student.lastName}"></td>
                  <td class="py-3" th:text="${student.firstName}"></td>
                  <td class="py-3">
                    <div
                      class="d-flex justify-content-around align-items-center"
                    >
                      <span
                        th:text="${student.email ?: '-'}"
                        class="me-2"
                      ></span>
                      <a
                        th:if="${student.email}"
                        th:href="'mailto:' + ${student.email}"
                        class="btn btn-sm btn-outline-primary"
                        title="Envoyer un email"
                      >
                        <i class="fas fa-envelope"></i>
                      </a>
                    </div>
                  </td>
                  <td class="py-3">
                    <div
                      class="d-flex justify-content-around align-items-center"
                    >
                      <span
                        th:text="${student.phone ?: '-'}"
                        class="me-2"
                      ></span>
                      <a
                        th:if="${student.phone}"
                        th:href="'tel:' + ${student.phone}"
                        class="btn btn-sm btn-outline-primary"
                        title="Appeler"
                      >
                        <i class="fas fa-phone"></i>
                      </a>
                    </div>
                  </td>
                  <td class="py-3">
                    <span
                      th:text="${student.schoolYears != null and !student.schoolYears.isEmpty() ? student.schoolYears[student.schoolYears.size() - 1].program : '-'}"
                    ></span>
                  </td>
                  <td class="py-3" onclick="event.stopPropagation();">
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-success me-2"
                      data-bs-toggle="modal"
                      th:data-bs-target="'#unarchiveModal' + ${student.id}"
                      title="Désarchiver"
                    >
                      <i class="fas fa-undo"></i>
                    </button>
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-danger"
                      data-bs-toggle="modal"
                      th:data-bs-target="'#deleteModal' + ${student.id}"
                      title="Supprimer définitivement"
                    >
                      <i class="fas fa-trash"></i>
                    </button>

                    <div
                      class="modal fade"
                      th:id="'unarchiveModal' + ${student.id}"
                      tabindex="-1"
                      aria-labelledby="unarchiveModalLabel"
                      aria-hidden="true"
                    >
                      <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                          <div class="modal-header bg-success text-white">
                            <h5 class="modal-title" id="unarchiveModalLabel">
                              Confirmer le désarchivage
                            </h5>
                            <button
                              type="button"
                              class="btn-close btn-close-white"
                              data-bs-dismiss="modal"
                              aria-label="Fermer"
                            ></button>
                          </div>
                          <div class="modal-body">
                            <p class="mb-0">
                              Êtes-vous sûr de vouloir désarchiver l'étudiant
                              <strong
                                th:text="${student.firstName + ' ' + student.lastName}"
                              ></strong>
                              ?
                            </p>
                            <p class="text-muted mt-2 mb-0">
                              <i class="fas fa-info-circle me-2"></i>
                              L'étudiant sera de nouveau actif dans le système.
                            </p>
                          </div>
                          <div class="modal-footer">
                            <button
                              type="button"
                              class="btn btn-secondary"
                              data-bs-dismiss="modal"
                            >
                              Annuler
                            </button>
                            <form
                              th:action="@{/archives/unarchive/{id}(id=${student.id})}"
                              method="post"
                              class="d-inline"
                            >
                              <button type="submit" class="btn btn-success">
                                <i class="fas fa-undo me-2"></i>Désarchiver
                              </button>
                            </form>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div
                      class="modal fade"
                      th:id="'deleteModal' + ${student.id}"
                      tabindex="-1"
                      aria-labelledby="deleteModalLabel"
                      aria-hidden="true"
                    >
                      <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                          <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title" id="deleteModalLabel">
                              Confirmer la suppression
                            </h5>
                            <button
                              type="button"
                              class="btn-close btn-close-white"
                              data-bs-dismiss="modal"
                              aria-label="Fermer"
                            ></button>
                          </div>
                          <div class="modal-body">
                            <p class="mb-0">
                              Êtes-vous sûr de vouloir supprimer définitivement
                              l'étudiant
                              <strong
                                th:text="${student.firstName + ' ' + student.lastName}"
                              ></strong>
                              ?
                            </p>
                            <p class="text-danger mt-2 mb-0">
                              <i class="fas fa-exclamation-triangle me-2"></i>
                              Cette action est irréversible.
                            </p>
                          </div>
                          <div class="modal-footer">
                            <button
                              type="button"
                              class="btn btn-secondary"
                              data-bs-dismiss="modal"
                            >
                              Annuler
                            </button>
                            <form
                              th:action="@{/archives/delete/{id}(id=${student.id})}"
                              method="post"
                              class="d-inline"
                            >
                              <button type="submit" class="btn btn-danger">
                                <i class="fas fa-trash me-2"></i>Supprimer
                              </button>
                            </form>
                          </div>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div th:replace="~{fragments/search-modal :: search-modal}"></div>

    <script th:src="@{/webjars/bootstrap/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/fonts/fontawesome/js/all.min.js}" defer></script>
    <script th:src="@{/js/header.js}"></script>
    <script th:src="@{/js/search.js}"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const rows = document.querySelectorAll(".clickable-row");
        rows.forEach((row) => {
          row.addEventListener("click", function () {
            window.location.href = this.dataset.href;
          });
        });
      });
    </script>
  </body>
</html>
